#!/usr/bin/env ruby

require 'optparse'
require 'cloudscopes'

def handle(samples)
  return Cloudscopes.publish(samples) if Cloudscopes.publish?
  samples.each do |category, samples|
    valid_data = samples.select(&:valid?)
    next if valid_data.empty?
    puts "#{category.rjust(10,' ')}: "
    valid_data.each { |s| puts "#{' '*12}#{s.name} - #{s.value} #{s.unit} (#{s.to_cloudwatch_metric_data})" }
  end
end

def exit_with_error(message)
  $stderr.puts(message)
  exit 1
end

publish = true
keep_running = false
option_parser = OptionParser.new do |opts|
  opts.banner = "Usage: #{$0} [options] <config.yaml>\n\nOptions:"
  opts.on("-t", "--test", "Dump samples to the console instead of publishing") do
    publish = false
  end
  opts.on("-l", "--loop", "Perform sampling periodically as defined by the metrics") do
    keep_running = true
  end
  opts.on_tail("-?", "-h", "--help", "Show this message") do
    puts(opts)
    exit
  end
end
begin
  arguments = option_parser.parse!
rescue OptionParser::ParseError
  exit_with_error(option_parser)
end
exit_with_error(option_parser) unless arguments.size == 1

Cloudscopes.init(config_file: arguments.first, publish: publish)

if keep_running
  while true
    handle(Cloudscopes.samples)
    Cloudscopes.reset
    GC.start
    sleep_time = Cloudscopes.next_sampling_time - Time.now
    sleep(sleep_time) if sleep_time > 0
  end
else
  handle(Cloudscopes.samples)
end
